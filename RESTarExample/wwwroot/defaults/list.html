<link rel="import" href="/sys/polymer/polymer.html">
<link rel="import" href="/sys/puppet-redirect/puppet-redirect.html"/>

<template>
    <template is="dom-bind" id="main">
        <h3>{{model.ResourceName}}</h3>
        <template is="dom-if" if="{{model.CanInsert}}">
            <div>
                <button class="btn btn-sm btn-primary" value="{{model.Add$::click}}" on onmouseup="++this.value">Add</button>
            </div>
        </template>
        <table class="table">
            <thead>
            <tr>
                <template is="dom-repeat" items="{{model.TableHead}}">
                    <th>{{item}}</th>
                </template>
            </tr>
            </thead>

            <tbody>
            <template is="dom-repeat" items="{{model.Entities}}" as="row">
                <tr>
                    <template is="dom-repeat" items="{{model.TableHead}}" as="name">
                        <template is="dom-if" if="{{_unique(name, model.UniqueIdentifiers)}}">
                            <td>
                                <a href="{{model.ResourcePath}}/{{name}}={{_byname(row,name)}}">{{_byname(row,name)}}</a>
                            </td>
                        </template>
                        <template is="dom-if" if="{{_notUnique(name, model.UniqueIdentifiers)}}">
                            <td>{{_byname(row,name)}}</td>
                        </template>
                    </template>
                </tr>
            </template>
            </tbody>
        </table>
        <link is="puppet-redirect" history url$="{{model.RedirectUrl$}}"/>
    </template>
    <script>
        var template = document.querySelector('template[id="main"]');
        template._byname = (obj, name) => {
            var val = obj[name + "$"];
            if (Array.isArray(val))
                return val.join(", ");
            return val;
        }
        template._unique = (name, uids) => {
            console.log("->" + uids);
            var contains = uids.indexOf(name);
            console.log(contains);
            return contains > -1;
        };
        template._notUnique = (name, uids) => {
            console.log("->" + uids);
            var contains = uids.indexOf(name);
            console.log(contains);
            return contains === -1;
        };
        template._members = obj => Object.keys(obj).map(key => ({
            name: key.slice(0, -1),
            value: obj[key]
        }));
    </script>
</template>